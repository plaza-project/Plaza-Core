<div class="program-pad">
    <div id="program-header" class="">
        <h2 class="program-name">
            <a href (click)="goBack()"><mat-icon class="back-arrow">arrow_back_ios</mat-icon></a>
            <span class="program-title" *ngIf="program !== undefined">{{program.name}}</span>
            <span class="program-title" *ngIf="program === undefined">Loading...</span>
        </h2>

        <span class="hint hint-scrollable">
            <mat-icon class="hint-icon " aria-label="Scrollable section" aria-hidden="true">expand_more</mat-icon>
            <span class="hint-text">Scroll to find more buttons</span>
        </span>

        <!-- Program state -->
        <button id="program-visibility-state" color="secondary"
            class="annotated-icon"
            [disabled]="!can_admin"
            (click)="changeVisibility()"
            mat-button mat-raised-button>

            <mat-icon *ngIf="visibility==='public'">public</mat-icon>
            <label *ngIf="visibility==='public'" class="label">
                Public
            </label>

            <mat-icon *ngIf="visibility==='shareable'">link</mat-icon>
            <label *ngIf="visibility==='shareable'" class="label">
                Shareable
            </label>

            <mat-icon *ngIf="visibility==='private'">lock</mat-icon>
            <label *ngIf="visibility==='private'" class="label">
                Private
            </label>
        </button>

        <button id="program-clone-button" color="secondary"
            class="annotated-icon"
            [disabled]="!program || !session.active"
            (click)="cloneProgram()"
            mat-button mat-raised-button>

            <img class="icon" src="/assets/icons/clone.svg" />
            <label class="label">
                Clone
            </label>
        </button>

        <!-- Basic functions -->
        <button mat-button mat-raised-button
            class="annotated-icon"
            id="program-start-button" color="primary"
            [disabled]="read_only"
            (click)="sendProgram()">

            <span class="load-bg"></span>
            <mat-icon class="action-icon">cloud_upload</mat-icon>
            <label class="label">
                Upload
            </label>
        </button>

        <button id="program-rename-button" color="secondary"
            class="annotated-icon"
            [disabled]="read_only"
            (click)="renameProgram()" mat-button mat-raised-button>
            <mat-icon>edit</mat-icon>
            <label class="label">
                Rename
            </label>
        </button>

        <button id="program-logs-button" color="secondary"
            class="annotated-icon"
            [disabled]="read_only"
            *ngIf="(this.streamingLogs || this.logCount > 0)"
            (click)="toggleLogsPanel()" mat-button mat-raised-button>
            <mat-icon>error_outline</mat-icon>
            <label class="label">
                <span *ngIf="drawer.opened && drawer_type === 'logs'">Hide</span>
                <span *ngIf="!(drawer.opened && drawer_type === 'logs')">Show</span>
                logs
            </label>
        </button>

        <button id="program-variables-button" color="secondary"
            class="annotated-icon"
            [disabled]="read_only"
            *ngIf="(this.streamingLogs || this.logCount > 0)"
            (click)="toggleVariablesPanel()" mat-button mat-raised-button>
            <mat-icon>storage</mat-icon>
            <label class="label">
                <span *ngIf="drawer.opened && drawer_type === 'variables'">Hide</span>
                <span *ngIf="!(drawer.opened && drawer_type === 'variables')">Show</span>
                variables
            </label>
        </button>

        <button id="program-stop-button" color="warn"
            class="annotated-icon"
            [disabled]="read_only"
            (click)="stopThreadsProgram()" mat-button mat-raised-button>
            <mat-icon>stop</mat-icon>
            <label class="label">
                Cancel running
            </label>
        </button>
        <!-- Advanced functions, on a menu -->
        <button id="advanced-program-controls-button" color="secondary"
            [matMenuTriggerFor]="advancedProgramControls"
            [disabled]="read_only"
            mat-button mat-raised-button>
            <mat-icon>more_vert</mat-icon> Advanced
        </button>
        <mat-menu  #advancedProgramControls="matMenu">
            <button mat-menu-item
                (click)="setProgramTags()">
                <mat-icon class="example-tab-icon">label</mat-icon>
                Tags
            </button>
        </mat-menu>


        <!-- Dangerous stuff, on its own -->
        <button id="program-delete-button" color="warn"
            [disabled]="read_only"
            (click)="deleteProgram()" mat-button mat-raised-button>
            <mat-icon>delete_forever</mat-icon> Delete program
        </button>
    </div>

    <mat-sidenav-container>
        <mat-sidenav #drawer mode="side" position="end">

            <div class="drawer-controls">
                <span class="closer">
                    <button (click)="closeDrawer()">
                        <mat-icon >close</mat-icon>
                    </button>
                </span>

                <mat-form-field class="selector">
                    <mat-select [(value)]="drawer_type">
                        <mat-option value="logs">Logs</mat-option>
                        <mat-option value="variables">Variables</mat-option>
                    </mat-select>
                </mat-form-field>
            </div>

            <div [class]="drawer_type !== 'logs' ? 'hidden program-drawer' : ' program-drawer'" id="logs_panel_container">
                Error logs are empty.
                <span id="contact-mail-call" *ngIf="environment && environment.contact_mail">
                    If you have any problem, contact us on <a class="contact-mail" href="mailto:{{environment.contact_mail}}">{{environment.contact_mail}}</a>
                </span>
            </div>
            <div [class]="drawer_type !== 'variables' ? 'hidden program-drawer' : 'program-drawer'" id="variables_panel_container">
                <table class="table var-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th class="name" scope="col">Var. name</th>
                            <th class="value" scope="col">Var. value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngFor="let v of variables">
                            <tr [class]="variablesToRemove.indexOf(v.name) >= 0 ? 'to-delete' : ''">
                                <td class="control">
                                    <button mat-button *ngIf="variablesToRemove.indexOf(v.name) < 0"
                                        class="remove-variable"
                                        (click)="removeVariable(v.name)" >
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                    <button mat-button *ngIf="variablesToRemove.indexOf(v.name) >= 0"
                                        class="remove-variable"
                                        (click)="unremoveVariable(v.name)" >
                                        <mat-icon>restore</mat-icon>
                                    </button>
                                </td>
                                <td class="name" scole="row">{{ v.name }}</td>
                                <td class="value">
                                    <mat-form-field>
                                        <input matInput
                                            required
                                            [(ngModel)]="v.value"
                                            (change)="updateVariable(v.name)"
                                            placeholder="Value" />
                                        <button mat-button [class]="v.value !== this.serverVariables[v.name] ? '': 'invisible'" matSuffix mat-icon-button aria-label="Clear" (click)="resetVariable(v.name)">
                                            <mat-icon>backspace</mat-icon>
                                        </button>
                                    </mat-form-field>
                                </td>
                            </tr>
                        </ng-container>
                        <tr *ngFor="let v of variablesInCreation">
                            <td class="control">
                                <button mat-button
                                    class="remove-variable"
                                    (click)="removeVariableInCreation(v.name)" >
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </td>
                            <td class="name" scole="row">
                                <mat-form-field>
                                    <input matInput
                                        required
                                        [(ngModel)]="v.name"
                                        placeholder="Name" />
                                </mat-form-field>
                            </td>
                            <td class="value">
                                <mat-form-field>
                                    <input matInput
                                        required
                                        [(ngModel)]="v.value"
                                        placeholder="Value" />
                                </mat-form-field>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <button color="primary"
                    id="add-variable-button"
                    [disabled]="read_only"
                    (click)="addVariable()" mat-button mat-raised-button>
                    <mat-icon>add</mat-icon>
                    <label class="label">
                        Add variable
                    </label>
                </button>

                <button color="primary"
                    id="upload-variable-button"
                    [disabled]="read_only || (updatedVariables.length + variablesInCreation.length + variablesToRemove.length) == 0"
                    (click)="uploadVariableChanges()" mat-button mat-raised-button>
                    <mat-icon>cloud_upload</mat-icon>
                    <label class="label">
                        Upload changes
                    </label>
                </button>
            </div>
        </mat-sidenav>

        <div class="viewer">
            <div id="workspace-read-only-marker" *ngIf="!isReady">
                <div class="message" *ngIf="nonReadyReason === 'loading'">
                    Loading…
                </div>
                <div class="message" *ngIf="nonReadyReason === 'disconnected'">
                    Connection lost.

                    <button mat-button mat-raised-button
                        (click)="force_reload()"  mat-button>

                        <mat-icon class="action-icon">refresh</mat-icon>
                        Refresh
                    </button>
                    to reconnect.
                </div>
            </div>
            <div id="workspace"></div>
        </div>
    </mat-sidenav-container>
    <div id="program-cursors"></div>
</div>
